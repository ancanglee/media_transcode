# GPU视频转码系统 - 架构设计

## 系统架构图

```
┌─────────────────┐       ┌─────────────────┐       ┌─────────────────┐
│   客户端应用     │       │   API服务器      │       │   GPU处理器      │
│                │       │  (任意服务器)    │       │  (GPU服务器)     │
│  - Web管理界面   │──────▶│  - REST API     │       │  - FFmpeg处理   │
│  - 移动应用      │       │  - Web界面(/admin)│      │  - GPU加速      │
│  - 第三方集成    │       │  - 任务管理      │       │  - 并发处理      │
│                │       │  - LLM智能转码   │       │                │
└─────────────────┘       └─────────────────┘       └─────────────────┘
                                 │                         │
        ┌────────────────────────┼─────────────────────────┼────────────────────────┐
        │                        │                         │                        │
        ▼                        ▼                         ▼                        ▼
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│  AWS Bedrock    │    │   AWS SQS       │    │   AWS S3        │    │  AWS DynamoDB   │
│  (Claude LLM)   │    │   消息队列       │    │   存储桶         │    │   数据库         │
│                │    │                │    │                │    │                │
│  - 智能转码建议  │    │  - 任务队列      │    │  - 输入视频      │    │  - 任务状态      │
│  - 参数优化      │    │  - 消息传递      │    │  - 输出视频      │    │  - 处理历史      │
│                │    │                │    │                │    │  - 自定义预设    │
└─────────────────┘    └─────────────────┘    └─────────────────┘    └─────────────────┘
                               ▲                     │
                               │      S3事件通知      │
                               └─────────────────────┘
```

## 数据流详图

```
                              手动触发流程
┌──────────┐  HTTP请求   ┌──────────┐  发送消息   ┌──────────┐
│  客户端   │───────────▶│ API服务器 │───────────▶│   SQS    │
└──────────┘            └──────────┘            └──────────┘
                              │                       │
                              │ 创建任务记录            │ 拉取消息
                              ▼                       ▼
                        ┌──────────┐            ┌──────────┐
                        │ DynamoDB │◀───────────│GPU处理器 │──────┐
                        └──────────┘  更新状态   └──────────┘      │
                                                     │            │
                              ┌───────────────────────┤            │
                              │ 下载视频              │ 上传结果    │ 删除消息
                              ▼                       ▼            │
                        ┌──────────┐            ┌──────────┐      │
                        │ S3输入桶  │            │ S3输出桶  │      │
                        └──────────┘            └──────────┘      │
                                                                  │
                        ┌──────────┐                              │
                        │   SQS    │◀─────────────────────────────┘
                        └──────────┘

                              自动触发流程
┌──────────┐  上传视频   ┌──────────┐  S3事件    ┌──────────┐
│   用户    │───────────▶│ S3输入桶  │───────────▶│   SQS    │
└──────────┘            └──────────┘            └──────────┘
                                                     │
                                                     │ 拉取消息
                                                     ▼
                                               ┌──────────┐
                                               │GPU处理器 │──────┐
                                               └──────────┘      │
                                                     │            │
                              ┌───────────────────────┤            │
                              │ 更新状态              │ 上传结果    │ 删除消息
                              ▼                       ▼            │
                        ┌──────────┐            ┌──────────┐      │
                        │ DynamoDB │            │ S3输出桶  │      │
                        └──────────┘            └──────────┘      │
                                                                  │
                        ┌──────────┐                              │
                        │   SQS    │◀─────────────────────────────┘
                        └──────────┘
```

## 组件说明

### API服务器 (`cmd/api-server`)
- 提供REST API接口
- 提供Web图形化管理界面 (`/admin`)
- 管理转码任务队列
- 监控处理状态
- 可部署在任意服务器上

### GPU处理器 (`cmd/gpu-processor`)
- 执行实际的视频转码
- 利用GPU硬件加速
- 必须部署在配备GPU的服务器上
- 支持并发处理多个任务

### AWS服务
- **S3**: 存储输入和输出视频文件
- **SQS**: 任务队列管理
- **DynamoDB**: 任务状态和元数据存储

## 项目结构

```
├── cmd/                    # 可执行程序入口
│   ├── api-server/        # API服务器
│   └── gpu-processor/     # GPU处理器
├── internal/              # 内部包
│   ├── api/              # API处理逻辑
│   │   ├── handlers.go   # 任务API处理器
│   │   ├── llm_handlers.go # LLM智能转码API
│   │   ├── router.go     # 路由配置
│   │   ├── static.go     # 静态文件服务
│   │   └── web/          # Web管理界面
│   │       ├── index.html
│   │       ├── style.css
│   │       └── app.js
│   ├── config/           # 配置管理
│   ├── llm/              # LLM集成 (Bedrock)
│   │   └── bedrock.go    # Claude API调用
│   ├── queue/            # 队列管理
│   ├── task/             # 任务管理
│   └── transcode/        # 转码逻辑
│       ├── ffmpeg.go     # FFmpeg命令构建
│       ├── platform.go   # 跨平台硬件检测
│       ├── preset.go     # 预设管理
│       └── processor.go  # 转码处理器
├── docs/                 # 文档
├── config.env            # 环境配置
└── Makefile             # 构建脚本
```

## 数据流

### 自动触发流程
1. 用户上传视频到 S3 输入桶
2. S3 事件通知触发，发送消息到 SQS
3. GPU处理器从 SQS 接收消息
4. GPU处理器下载视频、执行转码
5. 转码完成后上传到 S3 输出桶
6. 更新 DynamoDB 任务状态

### 手动触发流程
1. 用户通过 API 或 Web 界面提交任务
2. API服务器将任务发送到 SQS
3. 后续流程与自动触发相同

## 开发指南

### 添加新的转码格式
1. 在 `internal/transcode/processor.go` 中添加新的转码配置
2. 更新 `internal/task/models.go` 中的转码类型定义
3. 测试新格式的转码效果

### 贡献代码
1. Fork项目
2. 创建功能分支
3. 提交代码变更
4. 创建Pull Request
