<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GPU视频转码管理系统</title>
    <link rel="stylesheet" href="/static/style.css?v=20251211">
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>🎬 GPU视频转码管理系统</h1>
            <div class="health-status" id="healthStatus">
                <span class="status-dot"></span>
                <span class="status-text">检查中...</span>
            </div>
        </header>

        <nav class="nav-tabs">
            <button class="tab-btn active" data-tab="dashboard">📊 仪表盘</button>
            <button class="tab-btn" data-tab="ai-transcode">🤖 AI智能转码</button>
            <button class="tab-btn" data-tab="task-queue">📋 任务队列管理</button>
            <button class="tab-btn" data-tab="add-task">➕ 添加任务</button>
            <button class="tab-btn" data-tab="presets">⚙️ 预设管理</button>
        </nav>

        <!-- 仪表盘 -->
        <div class="tab-content active" id="dashboard">
            <div class="section-header" style="margin-bottom:20px;">
                <h2>📈 任务统计</h2>
                <div style="display:flex;gap:10px;align-items:center;">
                    <span id="platformInfo" class="platform-badge"></span>
                    <button class="btn btn-primary" onclick="refreshDashboard()">🔄 刷新统计</button>
                </div>
            </div>
            <div class="stats-grid">
                <div class="stat-card clickable" onclick="showTasksByStatus('pending')">
                    <div class="stat-icon">🕐</div>
                    <div class="stat-info">
                        <div class="stat-value" id="pendingTasks">-</div>
                        <div class="stat-label">任务等待</div>
                    </div>
                </div>
                <div class="stat-card clickable" onclick="showTasksByStatus('processing')">
                    <div class="stat-icon">🔄</div>
                    <div class="stat-info">
                        <div class="stat-value" id="processingTasks">-</div>
                        <div class="stat-label">任务处理中</div>
                    </div>
                </div>
                <div class="stat-card clickable" onclick="showTasksByStatus('completed')">
                    <div class="stat-icon">✅</div>
                    <div class="stat-info">
                        <div class="stat-value" id="completedTasks">-</div>
                        <div class="stat-label">任务已完成</div>
                    </div>
                </div>
                <div class="stat-card clickable" onclick="showTasksByStatus('failed')">
                    <div class="stat-icon">❌</div>
                    <div class="stat-info">
                        <div class="stat-value" id="failedTasks">-</div>
                        <div class="stat-label">任务失败</div>
                    </div>
                </div>
            </div>

            <!-- 展开的任务列表区域 -->
            <div class="section" id="dashboardTasksSection" style="display:none;">
                <div class="section-header">
                    <h2 id="dashboardTasksTitle">📋 任务列表</h2>
                    <button class="btn btn-secondary btn-small" onclick="closeDashboardTasks()">✕ 关闭</button>
                </div>
                <div class="table-container">
                    <table class="data-table" id="dashboardTasksTable">
                        <thead>
                            <tr>
                                <th>任务ID</th>
                                <th>输入文件</th>
                                <th>转码类型</th>
                                <th>状态</th>
                                <th>进度</th>
                                <th>创建时间</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
                <div class="pagination" id="dashboardTasksPagination"></div>
            </div>

            <div class="section">
                <h2>📋 最近任务</h2>
                <div class="table-container">
                    <table class="data-table" id="recentTasksTable">
                        <thead>
                            <tr>
                                <th>任务ID</th>
                                <th>输入文件</th>
                                <th>状态</th>
                                <th>创建时间</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- AI智能转码 -->
        <div class="tab-content" id="ai-transcode">
            <div class="form-panel">
                <h2>🤖 AI智能转码参数生成</h2>
                <p class="hint">用自然语言描述你的转码需求，AI会自动生成对应的FFmpeg参数</p>
                
                <form id="aiTranscodeForm" onsubmit="generateFFmpegParams(event)">
                    <div class="form-group">
                        <label for="aiRequirement">转码需求描述:</label>
                        <textarea id="aiRequirement" rows="3" required 
                            placeholder="例如：帮我把视频转成720p分辨率，保持较高画质，文件大小控制在原来的一半左右"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="aiInputFormat">输入格式 (可选):</label>
                        <input type="text" id="aiInputFormat" placeholder="例如: mp4, mov, avi">
                    </div>
                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="aiAutoTest" checked>
                            🧪 自动测试参数（使用示例视频验证参数有效性，失败时自动修正）
                        </label>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary btn-large" id="generateBtn">🚀 生成参数</button>
                    </div>
                </form>

                <!-- 生成结果 -->
                <div id="aiResult" class="ai-result" style="display:none;">
                    <h3>📋 生成结果</h3>
                    <div class="result-grid">
                        <div class="result-item">
                            <label>任务名称:</label>
                            <span id="resultName"></span>
                        </div>
                        <div class="result-item">
                            <label>描述:</label>
                            <span id="resultDescription"></span>
                        </div>
                        <div class="result-item">
                            <label>输出格式:</label>
                            <span id="resultOutputExt"></span>
                        </div>
                        <div class="result-item">
                            <label>预估速度:</label>
                            <span id="resultSpeed"></span>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>FFmpeg 参数:</label>
                        <pre id="resultArgs" class="code-block"></pre>
                    </div>
                    
                    <div class="form-group">
                        <label>参数解释:</label>
                        <div id="resultExplanation" class="explanation-box"></div>
                    </div>

                    <!-- 自动测试结果 -->
                    <div id="autoTestResult" class="test-result-box" style="display:none;">
                        <h4 id="autoTestTitle">🧪 自动测试结果</h4>
                        <div class="test-status" id="autoTestStatus"></div>
                        <div class="test-details">
                            <div class="form-group">
                                <label>执行命令:</label>
                                <pre id="autoTestCommand" class="code-block"></pre>
                            </div>
                            <div class="form-group" id="autoTestOutputGroup">
                                <label>FFmpeg 输出:</label>
                                <pre id="autoTestOutput" class="code-block" style="max-height:200px;overflow-y:auto;"></pre>
                            </div>
                        </div>
                    </div>

                    <div class="form-actions">
                        <button class="btn btn-secondary" onclick="testFFmpegParams()">🧪 手动测试</button>
                        <button class="btn btn-primary" id="savePresetBtn" onclick="saveAsPreset()">💾 确认保存为预设</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 任务队列管理（合并后） -->
        <div class="tab-content" id="task-queue">
            <!-- 队列状态 -->
            <div class="queue-status-panel" style="margin-bottom:20px;">
                <div class="section-header">
                    <h2>📬 队列状态</h2>
                    <div class="queue-actions">
                        <button class="btn btn-primary btn-small" onclick="refreshQueueStatus()">🔄 刷新</button>
                        <button class="btn btn-danger btn-small" onclick="purgeQueue()">🗑️ 清空队列</button>
                    </div>
                </div>
                <div class="queue-stats">
                    <div class="queue-stat">
                        <span class="queue-stat-label">等待处理:</span>
                        <span class="queue-stat-value" id="queueWaiting">-</span>
                    </div>
                    <div class="queue-stat">
                        <span class="queue-stat-label">正在处理:</span>
                        <span class="queue-stat-value" id="queueProcessing">-</span>
                    </div>
                </div>
            </div>

            <!-- 任务列表 -->
            <div class="section">
                <h2>📋 任务列表</h2>
                <div class="filter-bar">
                    <div class="filter-group">
                        <label>状态筛选:</label>
                        <select id="statusFilter">
                            <option value="">全部</option>
                            <option value="pending">等待中</option>
                            <option value="processing">处理中</option>
                            <option value="completed">已完成</option>
                            <option value="failed">失败</option>
                            <option value="retrying">重试中</option>
                            <option value="cancelled">已取消</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>日期:</label>
                        <input type="date" id="dateFilter">
                        <button class="btn btn-secondary btn-small" onclick="clearDateFilter()" title="清除日期筛选">✕</button>
                    </div>
                    <button class="btn btn-primary" onclick="loadTasks()">🔍 查询</button>
                    <button class="btn btn-secondary" onclick="refreshTasks()">🔄 刷新</button>
                </div>

                <div class="table-container">
                    <table class="data-table" id="tasksTable">
                        <thead>
                            <tr>
                                <th>任务ID</th>
                                <th>输入文件</th>
                                <th>转码类型</th>
                                <th>状态</th>
                                <th>进度</th>
                                <th>创建时间</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>

                <div class="pagination" id="tasksPagination"></div>
            </div>
        </div>

        <!-- 添加任务 -->
        <div class="tab-content" id="add-task">
            <div class="form-panel">
                <h2>➕ 添加转码任务</h2>
                <form id="addTaskForm" onsubmit="submitTask(event)">
                    <div class="form-group">
                        <label for="inputBucket">输入桶 (Input Bucket):</label>
                        <input type="text" id="inputBucket" required placeholder="例如: my-video-input-bucket">
                    </div>
                    <div class="form-group">
                        <label for="inputKey">输入文件路径 (Input Key):</label>
                        <input type="text" id="inputKey" required placeholder="例如: videos/sample.mp4">
                    </div>
                    <div class="form-group">
                        <label>转码类型:</label>
                        <div class="checkbox-group" id="transcodeTypeCheckboxes">
                            <!-- 动态加载预设 -->
                        </div>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary btn-large">🚀 提交任务</button>
                        <button type="reset" class="btn btn-secondary">🔄 重置</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- 预设管理 -->
        <div class="tab-content" id="presets">
            <div class="section">
                <div class="section-header">
                    <h2>⚙️ 转码预设管理</h2>
                    <button class="btn btn-primary" onclick="loadPresets()">🔄 刷新</button>
                </div>
                <div class="table-container">
                    <table class="data-table" id="presetsTable">
                        <thead>
                            <tr>
                                <th>预设ID</th>
                                <th>名称</th>
                                <th>描述</th>
                                <th>输出格式</th>
                                <th>类型</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- 任务详情模态框 -->
        <div class="modal" id="taskDetailModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>📋 任务详情</h3>
                    <button class="modal-close" onclick="closeModal()">&times;</button>
                </div>
                <div class="modal-body" id="taskDetailContent"></div>
            </div>
        </div>

        <!-- 测试转码模态框 -->
        <div class="modal" id="testModal">
            <div class="modal-content modal-large">
                <div class="modal-header">
                    <h3>🧪 测试转码参数</h3>
                    <button class="modal-close" onclick="closeTestModal()">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="testInputFile">本地测试文件路径:</label>
                        <input type="text" id="testInputFile" placeholder="例如: /tmp/test.mp4">
                    </div>
                    
                    <!-- 当前参数显示 -->
                    <div class="form-group">
                        <label>当前 FFmpeg 参数:</label>
                        <pre id="currentTestArgs" class="code-block" style="font-size:0.85rem;"></pre>
                    </div>
                    
                    <div class="form-actions">
                        <button class="btn btn-primary" id="runTestBtn" onclick="runTest()">▶️ 运行测试</button>
                    </div>
                    
                    <div id="testResult" style="display:none;">
                        <h4 id="testResultTitle">测试结果:</h4>
                        <pre id="testOutput" class="code-block" style="max-height:200px;overflow-y:auto;"></pre>
                        
                        <!-- 测试失败时显示的修正选项 -->
                        <div id="testFixSection" style="display:none;margin-top:16px;">
                            <div class="fix-hint">
                                <p>💡 测试失败？让 AI 帮你分析错误并修正参数</p>
                            </div>
                            <div class="form-actions">
                                <button class="btn btn-warning" id="fixParamsBtn" onclick="fixFailedParams()">🔧 AI 修正参数</button>
                            </div>
                        </div>
                        
                        <!-- 测试成功时显示的保存选项 -->
                        <div id="testSuccessSection" style="display:none;margin-top:16px;">
                            <div class="success-hint">
                                <p>✅ 测试通过！你可以保存这个参数配置为预设</p>
                            </div>
                            <div class="form-actions">
                                <button class="btn btn-primary" onclick="closeTestModal();saveAsPreset();">💾 保存为预设</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 保存预设模态框 -->
        <div class="modal" id="savePresetModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>💾 保存为预设</h3>
                    <button class="modal-close" onclick="closeSavePresetModal()">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="presetName">预设名称:</label>
                        <input type="text" id="presetName" required>
                    </div>
                    <div class="form-group">
                        <label for="presetDescription">描述:</label>
                        <textarea id="presetDescription" rows="2"></textarea>
                    </div>
                    <div class="form-actions">
                        <button class="btn btn-primary" onclick="confirmSavePreset()">💾 保存</button>
                        <button class="btn btn-secondary" onclick="closeSavePresetModal()">取消</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Toast 通知 -->
        <div class="toast-container" id="toastContainer"></div>
    </div>

    <script src="/static/app.js?v=20251211"></script>
</body>
</html>
